<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>노래 추가</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }

        .form-container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: bold;
        }

        input[type="text"],
        textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }

        textarea {
            resize: vertical;
            min-height: 150px;
        }

        .submit-button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        .submit-button:hover {
            background-color: #45a049;
        }

        .back-link {
            display: inline-block;
            margin-top: 20px;
            color: #2196F3;
            text-decoration: none;
        }

        .back-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <h1>노래 추가</h1>
    <div class="form-container">
        <form action="/add" method="POST">
            <div class="form-group">
                <label for="title">URL 제목 (영문, 공백 없이):</label>
                <input type="text" id="title" name="title" required>
            </div>
            
            <div class="form-group">
                <label for="ori_name">노래 원어명:</label>
                <input type="text" id="ori_name" name="ori_name" required>
            </div>
            
            <div class="form-group">
                <label for="kor_name">노래 한국어명:</label>
                <input type="text" id="kor_name" name="kor_name" required>
            </div>
            
            <div class="form-group">
                <label for="eng_name">노래 영어명:</label>
                <input type="text" id="eng_name" name="eng_name" required>
            </div>
            
            <div class="form-group">
                <label for="vid">유튜브 영상 주소[11자리] (예시: CGj85pVzRJs)</label>
                <input type="text" id="vid" name="vid">
            </div>

            <div class="form-group">
                <label for="artist">가수명:</label>
                <input type="text" id="artist" name="artist" required>
            </div>

            <div class="form-group">
                <label for="text">노래 가사: [긴 문장은 개행을 해서 두 줄로 나누는 것이 좋습니다!]</label>
                <textarea id="text" name="text" required></textarea>
            </div>

            <button type="submit" class="submit-button">저장</button>
        </form>
    </div>
    <a href="/songs" class="back-link">노래 목록 보기</a>

    <script>
    // URL 제목 유효성 검사 함수
    function validateTitle(title) {
        // 빈 문자열 체크
        if (!title || title.trim() === '') {
            return {
                isValid: false,
                error: '제목을 입력해주세요.'
            };
        }

        // 길이 체크 (최대 100자)
        if (title.length > 100) {
            return {
                isValid: false,
                error: '제목은 100자를 초과할 수 없습니다.'
            };
        }

        // 영문, 숫자, 하이픈, 언더스코어만 허용
        const validPattern = /^[a-zA-Z0-9-_]+$/;
        if (!validPattern.test(title)) {
            return {
                isValid: false,
                error: '제목은 영문, 숫자, 하이픈(-), 언더스코어(_)만 사용할 수 있습니다.'
            };
        }

        return {
            isValid: true,
            title: title.trim()
        };
    }

    // 폼 제출 시 유효성 검사
    document.querySelector('form').addEventListener('submit', function(e) {
        const titleInput = document.getElementById('title');
        const validation = validateTitle(titleInput.value);
        
        if (!validation.isValid) {
            e.preventDefault();
            alert(validation.error);
            titleInput.focus();
            return false;
        }
    });

    // 실시간 유효성 검사
    document.getElementById('title').addEventListener('input', function(e) {
        const validation = validateTitle(this.value);
        if (!validation.isValid) {
            this.setCustomValidity(validation.error);
        } else {
            this.setCustomValidity('');
        }
    });

    // 기존의 auto-fill-names 코드
    document.getElementById('ori_name').addEventListener('blur', async function() {
        const oriName = this.value;
        if (!oriName) return;

        try {
            const response = await fetch('/auto-fill-names', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ ori_name: oriName })
            });

            const data = await response.json();
            if (data.kor_name) document.getElementById('kor_name').value = data.kor_name;
            if (data.eng_name) document.getElementById('eng_name').value = data.eng_name;
        } catch (error) {
            console.error('Error:', error);
        }
    });

    // 유튜브 URL에서 영상 ID 추출 로직
    document.getElementById('vid').addEventListener('input', function() {
        const url = this.value;
        let videoId = '';

        // 케이스 1: youtu.be/ 다음 11자리 (모바일)
        const mobileRegex = /youtu\.be\/([^\?&\/]{11})/;
        const mobileMatch = url.match(mobileRegex);
        if (mobileMatch && mobileMatch[1]) {
            videoId = mobileMatch[1];
        } else {
            // 케이스 2: youtube.com/watch?v= 다음 11자리 (웹)
            const webRegex = /watch\?v=([^\?&\/]{11})/;
            const webMatch = url.match(webRegex);
            if (webMatch && webMatch[1]) {
                videoId = webMatch[1];
            } else if (url.length === 11 && /^[a-zA-Z0-9_-]+$/.test(url)) {
                // 이미 11자리 ID인 경우
                videoId = url;
            }
        }
        
        // 추출된 ID가 있으면 해당 ID로 값을 변경하고, 아니면 원래 입력값을 유지하도록 처리할 수 있습니다.
        // 여기서는 추출된 ID가 있을 경우에만 값을 변경합니다.
        if (videoId) {
            this.value = videoId;
            this.setCustomValidity(''); // 성공 시 유효성 메시지 초기화
        } else {
            // ID 추출 실패 시 사용자에게 알림
            if (url.trim() !== '') { // 입력값이 비어있지 않을 때만 메시지 표시
                this.setCustomValidity('유효한 유튜브 URL 형식이 아니거나, 11자리 영상 ID를 입력해주세요.');
            } else {
                this.setCustomValidity(''); // 입력값이 비면 메시지 없음
            }
        }
    });
    </script>
</body>
</html>
