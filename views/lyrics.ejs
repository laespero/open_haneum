<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= song.kor_name || song.ori_name || song.name %> - 가사 정보</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
    <link rel="manifest" href="/favicon/site.webmanifest">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
</head>
<body class="bg-slate-50 text-slate-800 font-sans">
    <%- include('partials/header') %>

    <main class="container mx-auto max-w-5xl px-4 sm:px-6 lg:px-8 py-12">
        <!-- 곡 정보 및 액션 버튼 -->
        <section class="bg-white p-6 sm:p-8 rounded-2xl shadow-xl mb-12">
            <div class="flex flex-col md:flex-row gap-8 items-center">
                <% if (song.vid && song.vid.trim() !== '') { %>
                    <div class="w-full md:w-[280px] flex-shrink-0">
                        <a href="https://www.youtube.com/watch?v=<%= song.vid %>" target="_blank" rel="noopener noreferrer" class="block overflow-hidden rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300">
                            <img src="https://img.youtube.com/vi/<%= song.vid %>/hqdefault.jpg" alt="<%= song.ori_name || song.name %> 썸네일" class="w-full aspect-video object-cover transform scale-110 transition-transform duration-300">
                        </a>
                    </div>
                <% } %>

                <div class="flex-grow w-full text-center md:text-left">
                    <a href="/songs?q=<%= encodeURIComponent(typeof song.artist === 'object' ? song.artist.ori_name : song.artist) %>" class="text-sm font-semibold text-blue-600 uppercase tracking-wider hover:underline"><%= typeof song.artist === 'object' ? song.artist.ori_name : song.artist %></a>
                    <% if (typeof song.artist === 'object' && song.artist.kor_name) { %>
                        <p class="text-xs text-slate-500 mt-1"><%= song.artist.kor_name %></p>
                    <% } %>
                    
                    <h1 class="text-3xl sm:text-4xl font-extrabold text-slate-900 mt-2"><%= song.ori_name || song.name %></h1>
                    <% if (song.kor_name) { %>
                        <p class="text-2xl text-slate-700 mt-1"><%= song.kor_name %></p>
                    <% } %>
                    <% if (song.eng_name) { %>
                        <p class="text-xl text-slate-500 mt-1"><%= song.eng_name %></p>
                    <% } %>

                    <% if (song.tags && song.tags.length > 0) { %>
                        <div class="flex flex-wrap justify-center md:justify-start gap-2 mt-4">
                            <% song.tags.forEach(tag => { %>
                                <a href="/songs?q=<%= encodeURIComponent(tag) %>" class="bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-1 rounded-full hover:bg-blue-200 transition-colors"><%= tag %></a>
                            <% }); %>
                        </div>
                    <% } %>
                </div>
            </div>

            <div class="mt-8 pt-8 border-t border-slate-100 flex flex-col md:flex-row items-center gap-4">
                <a href="/view/<%= song.name %>" 
                   class="w-full md:w-auto inline-flex items-center justify-center gap-3 bg-blue-600 text-white font-bold px-8 py-4 rounded-2xl hover:bg-blue-700 transition-all shadow-lg shadow-blue-200 active:scale-95 group">
                    <i class="fa-solid fa-graduation-cap text-lg group-hover:scale-110 transition-transform"></i>
                    <span>학습하기</span>
                </a>

                <% if (locals.currentUser) { %>
                    <div class="flex items-center gap-3 w-full md:w-auto">
                        <button id="likeBtn" data-liked="<%= liked ? '1' : '0' %>"
                                class="flex-grow md:flex-none inline-flex items-center justify-center gap-2 border-2 border-slate-100 text-slate-600 font-bold px-6 py-4 rounded-2xl hover:bg-pink-50 hover:border-pink-200 hover:text-pink-600 transition-all active:scale-95">
                            <i class="fa-solid fa-heart"></i>
                            <span>좋아요</span>
                        </button>

                        <div class="relative group/playlist flex-grow md:flex-none">
                            <button class="w-full inline-flex items-center justify-center gap-2 border-2 border-slate-100 text-slate-600 font-bold px-6 py-4 rounded-2xl hover:bg-purple-50 hover:border-purple-200 hover:text-purple-600 transition-all active:scale-95">
                                <i class="fa-solid fa-list-ul"></i>
                                <span>플레이리스트</span>
                                <i class="fas fa-chevron-down text-[10px] text-gray-400 group-hover/playlist:rotate-180 transition-transform"></i>
                            </button>
                            
                            <div class="absolute right-0 bottom-full mb-3 w-72 bg-white rounded-[2rem] shadow-2xl border border-gray-100 py-5 opacity-0 invisible group-hover/playlist:opacity-100 group-hover/playlist:visible transition-all duration-300 z-50 origin-bottom-right transform scale-95 group-hover/playlist:scale-100">
                                <div class="px-6 pb-3 mb-3 border-b border-gray-50">
                                    <p class="text-[10px] font-black text-gray-400 uppercase tracking-widest">내 플레이리스트</p>
                                </div>
                                <div class="max-h-64 overflow-y-auto px-2 space-y-1" id="playlistList">
                                    <% playlists.forEach(pl => { %>
                                        <button onclick="togglePlaylistMembership('<%= pl.id %>', this)" 
                                                data-in="<%= pl.is_in %>"
                                                class="w-full text-left px-4 py-3 text-sm font-bold text-gray-700 hover:bg-purple-50/50 hover:text-purple-600 rounded-xl transition-all flex items-center justify-between group/item">
                                            <div class="flex items-center gap-3">
                                                <div class="w-8 h-8 rounded-lg <%= pl.is_in ? 'bg-purple-600 text-white' : 'bg-gray-50 text-gray-400' %> group-hover/item:bg-purple-100 group-hover/item:text-purple-600 transition-colors flex items-center justify-center">
                                                    <i class="fas fa-music text-[10px]"></i>
                                                </div>
                                                <span class="truncate"><%= pl.name %></span>
                                            </div>
                                            <% if (pl.is_in) { %>
                                                <i class="fas fa-check text-[10px] text-purple-600"></i>
                                            <% } %>
                                        </button>
                                    <% }) %>
                                </div>
                                <div class="mt-4 pt-4 border-t border-gray-50 px-4 space-y-2">
                                    <% if (playlists.length < 100) { %>
                                        <button onclick="createNewPlaylist()" class="w-full text-left px-4 py-3 text-sm font-black text-blue-600 hover:bg-blue-50 rounded-xl transition-all flex items-center gap-3">
                                            <div class="w-8 h-8 rounded-lg bg-blue-50 flex items-center justify-center">
                                                <i class="fas fa-plus text-[10px]"></i>
                                            </div>
                                            <span>새 플레이리스트 만들기</span>
                                        </button>
                                    <% } else { %>
                                        <div class="px-4 py-3 text-[10px] font-bold text-red-400 bg-red-50 rounded-xl flex items-center gap-2">
                                            <i class="fas fa-exclamation-circle"></i>
                                            <span>플레이리스트 생성 한도(100개) 도달</span>
                                        </div>
                                    <% } %>
                                    <a href="/playlists" class="block text-center py-2 text-[10px] font-black text-gray-400 hover:text-blue-600 transition-colors uppercase tracking-[0.2em]">
                                        플레이리스트 관리 <i class="fas fa-external-link-alt ml-1"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                <% } else { %>
                    <a href="/login?next=<%= encodeURIComponent('/songs/' + song.name) %>"
                       class="w-full md:w-auto inline-flex items-center justify-center gap-3 border-2 border-slate-100 text-slate-500 font-bold px-8 py-4 rounded-2xl hover:bg-slate-50 hover:border-slate-200 transition-all active:scale-95">
                        <i class="fa-solid fa-heart"></i>
                        <span>로그인하고 저장</span>
                    </a>
                <% } %>

                <a href="/detail/<%= song.name %>" class="w-full md:w-auto md:ml-auto inline-flex items-center justify-center gap-2 text-slate-400 font-bold px-6 py-4 rounded-2xl hover:bg-slate-50 hover:text-slate-600 transition-all">
                    <i class="fas fa-edit"></i>
                    <span>번역 관리</span>
                </a>
            </div>
        </section>

        <!-- 전체 가사 보기 -->
        <section class="bg-white p-6 sm:p-8 rounded-2xl shadow-xl">
            <h2 class="text-3xl font-bold text-slate-900 mb-8">노래 가사</h2>
            <div class="space-y-6">
                <% if (Array.isArray(song.translatedLines) && song.translatedLines.length > 0) { %>
                    <% song.translatedLines.forEach(line => { %>
                        <div class="border-b border-slate-200/80 pb-5 last:border-b-0">
                            <% if (line.R0 && line.R0.trim() !== '' && line.R0.trim() !== line.T0.trim()) { %>
                                <p class="text-slate-500 font-medium text-md leading-relaxed tracking-wide"><%= line.R0 %></p>
                            <% } %>
                            <p class="text-slate-900 font-semibold text-lg leading-relaxed mt-1"><%= line.T0 %></p>
                            <p class="text-blue-600 mt-2 text-base font-medium"><%= line.K0 %></p>
                        </div>
                    <% }); %>
                <% } else { %>
                    <div class="text-center py-12">
                        <div class="mx-auto w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mb-4">
                            <i class="fas fa-file-alt text-3xl text-slate-400"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-slate-800">아직 번역된 내용이 없습니다</h3>
                        <p class="text-slate-500 mt-2">'번역 관리' 페이지로 이동하여 번역을 시작해 보세요.</p>
                        <a href="/detail/<%= song.name %>" class="mt-6 inline-flex items-center justify-center gap-2 bg-blue-600 text-white font-bold px-6 py-2.5 rounded-full hover:bg-blue-700 transition-all shadow-md hover:shadow-lg">
                            <i class="fas fa-edit fa-fw"></i>
                            <span>번역 관리로 이동</span>
                        </a>
                    </div>
                <% } %>
            </div>
        </section>
    </main>

    <footer class="text-center py-10 mt-8">
        <a href="/songs?q=<%= typeof song.artist === 'object' ? song.artist.ori_name : song.artist %>" class="text-slate-500 hover:text-blue-600 transition-colors">
            <i class="fas fa-arrow-left fa-fw mr-1"></i> <%= typeof song.artist === 'object' ? song.artist.ori_name : song.artist %>의 다른 곡 보기
        </a>
    </footer>

    <%- include('partials/footer') %>
    <script>
        document.querySelectorAll('.disable-on-submit').forEach(form => {
            form.addEventListener('submit', function(event) {
                const button = form.querySelector('button[type="submit"]');
                if (button) {
                    button.disabled = true;
                    const processingText = button.getAttribute('data-processing-text') || '처리중...';
                    button.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${processingText}`;
                    button.classList.add('opacity-70', 'cursor-wait');
                }
            });
        });
    </script>
    <% if (currentUser) { %>
    <script>
        const likeBtn = document.getElementById('likeBtn');
        const updateLikeUi = (isLiked) => {
            likeBtn.dataset.liked = isLiked ? '1' : '0';
            if (isLiked) {
                likeBtn.classList.add('bg-pink-600', 'border-pink-600', 'text-white', 'shadow-lg', 'shadow-pink-100');
                likeBtn.classList.remove('bg-white', 'border-slate-100', 'text-slate-600', 'hover:bg-pink-50', 'hover:border-pink-200', 'hover:text-pink-600');
            } else {
                likeBtn.classList.remove('bg-pink-600', 'border-pink-600', 'text-white', 'shadow-lg', 'shadow-pink-100');
                likeBtn.classList.add('bg-white', 'border-slate-100', 'text-slate-600', 'hover:bg-pink-50', 'hover:border-pink-200', 'hover:text-pink-600');
            }
        };
        updateLikeUi(likeBtn.dataset.liked === '1');
        likeBtn.addEventListener('click', async () => {
            const res = await fetch('/api/likes/toggle', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ songName: '<%= song.name %>' })
            });
            if (res.ok) {
                const data = await res.json();
                updateLikeUi(data.liked);
            } else {
                haneumAlert('좋아요 처리에 실패했습니다.', { type: 'danger' });
            }
        });

        async function createNewPlaylist() {
            haneumPrompt('새 플레이리스트의 이름을 입력해주세요.', async (name) => {
                if (!name || !name.trim()) return;

                try {
                    const res = await fetch('/api/playlists', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name: name.trim() })
                    });
                    const data = await res.json();
                    
                    if (data.ok) {
                        const list = document.getElementById('playlistList');
                        const btn = document.createElement('button');
                        btn.onclick = function() { togglePlaylistMembership(data.id, this); };
                        btn.dataset.in = "0";
                        btn.className = "w-full text-left px-4 py-3 text-sm font-bold text-gray-700 hover:bg-purple-50/50 hover:text-purple-600 rounded-xl transition-all flex items-center justify-between group/item";
                        btn.innerHTML = `
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-lg bg-gray-50 text-gray-400 group-hover/item:bg-purple-100 group-hover/item:text-purple-600 flex items-center justify-center transition-colors">
                                    <i class="fas fa-music text-[10px]"></i>
                                </div>
                                <span class="truncate">${data.name}</span>
                            </div>
                        `;
                        list.insertBefore(btn, list.firstChild);
                        
                        // 바로 현재 곡 추가
                        togglePlaylistMembership(data.id, btn);
                    } else {
                        haneumAlert(data.error || '플레이리스트 생성에 실패했습니다.', { type: 'danger' });
                    }
                } catch (err) {
                    console.error(err);
                    haneumAlert('오류가 발생했습니다.', { type: 'danger' });
                }
            }, {
                title: '플레이리스트 생성',
                inputPlaceholder: '예: 비오는 날 듣기 좋은 노래',
                confirmText: '생성하기'
            });
        }

        async function togglePlaylistMembership(playlistId, btn) {
            const isIn = btn.dataset.in === "1";
            const method = isIn ? 'DELETE' : 'POST';
            
            try {
                const res = await fetch(`/api/playlists/${playlistId}/songs`, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ songName: '<%= song.name %>' })
                });

                if (res.ok) {
                    const newIn = !isIn;
                    btn.dataset.in = newIn ? "1" : "0";
                    
                    // Update UI
                    const iconContainer = btn.querySelector('.w-8.h-8');
                    if (newIn) {
                        iconContainer.classList.remove('bg-gray-50', 'text-gray-400', 'bg-purple-100', 'text-purple-600');
                        iconContainer.classList.add('bg-purple-600', 'text-white');
                        if (!btn.querySelector('.fa-check')) {
                            const checkIcon = document.createElement('i');
                            checkIcon.className = "fas fa-check text-[10px] text-purple-600";
                            btn.appendChild(checkIcon);
                        }
                        haneumAlert('플레이리스트에 추가했습니다.', { type: 'success', icon: 'fa-check-circle' });
                    } else {
                        iconContainer.classList.remove('bg-purple-600', 'text-white', 'bg-purple-100', 'text-purple-600');
                        iconContainer.classList.add('bg-gray-50', 'text-gray-400');
                        const checkIcon = btn.querySelector('.fa-check');
                        if (checkIcon) checkIcon.remove();
                        haneumAlert('플레이리스트에서 삭제했습니다.', { type: 'info' });
                    }
                } else {
                    const data = await res.json().catch(() => ({}));
                    haneumAlert(data.error || (isIn ? '삭제에 실패했습니다.' : '추가에 실패했습니다.'), { type: 'danger' });
                }
            } catch (err) {
                console.error(err);
                haneumAlert('오류가 발생했습니다.', { type: 'danger' });
            }
        }
    </script>
    <% } %>
</body>
</html> 
